{% extends "base.html" %}

{% block title %}–õ–µ–æ ‚Äî –§–∏–Ω–∞–Ω—Å—ã{% endblock %}

{% block styles %}
<style>
/* === –ï–î–ò–ù–ê–Ø –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê === */
:root {
  --bg: transparent;
  --card-bg: rgba(255, 255, 255, 0.95);
  --text: #212121;
  --text-secondary: #757575;
  --border: rgba(178, 255, 89, 0.2);
  --accent: #4CAF50;
  --accent-light: #B2FF59;
  --gold: linear-gradient(-45deg, #DAA520, #FFD700, #F4C430, #C5B358, #DAA520);
  --gold-soft: linear-gradient(-45deg, #D4A017, #E6C229, #F4C430, #D4A017);
  --radius-sm: 8px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --shadow: 0 6px 20px rgba(76, 175, 80, 0.08);
  --shadow-hover: 0 12px 28px rgba(76, 175, 80, 0.16), 0 16px 40px rgba(0, 0, 0, 0.12);
  --transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

/* === –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê === */
[data-theme="dark"] {
  --bg: transparent;
  --card-bg: rgba(30, 30, 30, 0.95);
  --text: #ffffff;
  --text-secondary: #b0b0b0;
  --border: rgba(178, 255, 89, 0.1);
}

/* === –ì–õ–ê–í–ù–´–ô –§–û–ù === */
body, html {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  color: var(--text);
  background: linear-gradient(135deg, #f0fff0, #d9f7d9, #e6ffeb);
  background-size: 400% 400%;
  animation: gradient-shift 15s ease infinite;
  min-height: 100vh;
  overflow-x: hidden;
}

[data-theme="dark"] body {
  background: linear-gradient(135deg, #0a1e0a, #0c240c, #0d2a0d);
}

@keyframes gradient-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* === –ö–û–ù–¢–ï–ô–ù–ï–† === */
.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
}

/* === –ó–ê–ì–û–õ–û–í–û–ö === */
.finance-header {
  text-align: center;
  margin: 40px 0 30px;
}

.finance-header h1 {
  font-size: 28px;
  font-weight: 700;
  color: var(--accent);
  margin: 0 0 8px 0;
}

.finance-header p {
  color: var(--text-secondary);
  font-size: 15px;
}

/* === –ö–ê–†–¢–´ === */
.card {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 20px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 20px;
  transition: transform var(--transition);
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}

.card h3 {
  margin: 0 0 16px 0;
  font-size: 18px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* === –§–û–†–ú–´ === */
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 500;
}

.form-group input,
.form-group select,
.form-group button {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 15px;
  background: var(--card-bg);
  color: var(--text);
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--accent);
}

/* === –ö–ù–û–ü–ö–ò === */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: #4CAF50;
  margin-bottom: 8px;
}

.btn-primary {
  background: var(--gold);
  background-size: 200% 200%;
  animation: gradient-shift-gold 3s ease infinite;
  color: white;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(76, 175, 80, 0.25);
}

/* === –ö–ê–¢–ê–õ–û–ì–ò === */
.catalog-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.catalog-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  background: rgba(76, 175, 80, 0.06);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
}

.catalog-item:hover {
  background: rgba(76, 175, 80, 0.1);
}

.catalog-item.active {
  border-color: var(--accent);
  background: rgba(76, 175, 80, 0.15);
  font-weight: 600;
}

.catalog-item .name {
  font-weight: 500;
}

.catalog-item .stats {
  font-size: 13px;
  color: var(--text-secondary);
}

/* === –û–ü–ï–†–ê–¶–ò–ò === */
.operation-list {
  max-height: 300px;
  overflow-y: auto;
  margin-top: 16px;
  padding-right: 8px;
}

.operation {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.operation:last-child {
  border-bottom: none;
}

.operation.income {
  color: #4CAF50;
}

.operation.expense {
  color: #f44336;
}

/* === –ê–ù–ò–ú–ê–¶–ò–ò === */
@keyframes gradient-shift-gold {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* === –ê–î–ê–ü–¢–ò–í === */
@media (max-width: 768px) {
  .container {
    padding: 16px;
  }
}
</style>
{{ super() }}
{% endblock %}

{% block content %}
  <div class="container">
    <div class="finance-header">
      <h1>üìÅ –§–∏–Ω–∞–Ω—Å—ã</h1>
      <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ –±—é–¥–∂–µ—Ç–æ–º</p>
    </div>

    <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ -->
    <div class="card">
      <h3><span class="material-icons">folder</span> –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥</h3>
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="catalog-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: YouTube-–∫–∞–Ω–∞–ª">
      </div>
      <button class="btn btn-primary" onclick="createCatalog()">üìÅ –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ -->
    <div class="card">
      <h3><span class="material-icons">list</span> –ú–æ–∏ –∫–∞—Ç–∞–ª–æ–≥–∏</h3>
      <div class="catalog-list" id="catalog-list">
        <div class="catalog-item empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤</div>
      </div>
    </div>

    <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ -->
    <div class="card" id="catalog-operations" style="display: none;">
      <h3><span class="material-icons">account_balance</span> <span id="current-catalog">[–ö–∞—Ç–∞–ª–æ–≥]</span></h3>
      <div class="form-group">
        <label>–°—É–º–º–∞ (‚ÇΩ)</label>
        <input type="number" id="op-amount" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000">
      </div>
      <div class="btn-group">
        <button class="btn" onclick="addIncomeToCatalog()">‚ûï –î–æ—Ö–æ–¥</button>
        <button class="btn" onclick="addExpenseToCatalog()">‚ûñ –†–∞—Å—Ö–æ–¥</button>
      </div>
      <div class="operation-list" id="op-list"></div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // –î–∞–Ω–Ω—ã–µ
    let catalogs = JSON.parse(localStorage.getItem('finance_catalogs') || '[]');
    let currentCatalogId = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      renderCatalogs();
      if (catalogs.length > 0) {
        selectCatalog(catalogs[0].id);
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞
    function createCatalog() {
      const name = document.getElementById('catalog-name').value.trim();
      if (!name) return Toast.error('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const newCatalog = {
        id: Date.now(),
        name,
        balance: 0,
        income: 0,
        expense: 0,
        operations: []
      };

      catalogs.push(newCatalog);
      saveCatalogs();
      renderCatalogs();
      document.getElementById('catalog-name').value = '';
      Toast.success(`üìÅ "${name}" —Å–æ–∑–¥–∞–Ω`);

      if (catalogs.length === 1) {
        selectCatalog(newCatalog.id);
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
    function renderCatalogs() {
      const listEl = document.getElementById('catalog-list');
      if (catalogs.length === 0) {
        listEl.innerHTML = '<div class="catalog-item empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤</div>';
        return;
      }

      listEl.innerHTML = '';
      catalogs.forEach(cat => {
        const div = document.createElement('div');
        div.className = `catalog-item ${cat.id === currentCatalogId ? 'active' : ''}`;
        div.onclick = () => selectCatalog(cat.id);
        div.innerHTML = `
          <div class="name">${cat.name}</div>
          <div class="stats">‚ÇΩ ${cat.balance} (–¥–æ—Ö: ${cat.income}, —Ä–∞—Å—Ö: ${cat.expense})</div>
        `;
        listEl.appendChild(div);
      });
    }

    // –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥
    function selectCatalog(id) {
      currentCatalogId = id;
      renderCatalogs();
      const cat = catalogs.find(c => c.id === id);
      if (!cat) return;

      document.getElementById('catalog-operations').style.display = 'block';
      document.getElementById('current-catalog').textContent = cat.name;
      renderOperations(cat);
    }

    // –†–µ–Ω–¥–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π
    function renderOperations(cat) {
      const listEl = document.getElementById('op-list');
      if (cat.operations.length === 0) {
        listEl.innerHTML = '<div style="color: var(--text-secondary); font-size: 14px;">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
        return;
      }

      listEl.innerHTML = '';
      cat.operations.forEach(op => {
        const div = document.createElement('div');
        div.className = `operation ${op.type}`;
        div.innerHTML = `
          <div>${op.title}</div>
          <div>${op.type === 'income' ? '+' : '-'}${op.amount} ‚ÇΩ</div>
        `;
        listEl.appendChild(div);
      });
    }

    // –î–æ—Ö–æ–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
    function addIncomeToCatalog() {
      const amount = parseFloat(document.getElementById('op-amount').value);
      if (isNaN(amount) || amount <= 0) return Toast.error('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');

      const cat = catalogs.find(c => c.id === currentCatalogId);
      if (!cat) return;

      cat.balance += amount;
      cat.income += amount;
      cat.operations.push({ type: 'income', title: '–î–æ—Ö–æ–¥', amount, date: new Date() });

      saveCatalogs();
      selectCatalog(currentCatalogId);
      document.getElementById('op-amount').value = '';
      Toast.success(`+${amount} ‚ÇΩ –¥–æ–±–∞–≤–ª–µ–Ω–æ`);
    }

    // –†–∞—Å—Ö–æ–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
    function addExpenseToCatalog() {
      const amount = parseFloat(document.getElementById('op-amount').value);
      if (isNaN(amount) || amount <= 0) return Toast.error('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
      if (amount > catalogs.find(c => c.id === currentCatalogId)?.balance) {
        return Toast.error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
      }

      const cat = catalogs.find(c => c.id === currentCatalogId);
      cat.balance -= amount;
      cat.expense += amount;
      cat.operations.push({ type: 'expense', title: '–†–∞—Å—Ö–æ–¥', amount, date: new Date() });

      saveCatalogs();
      selectCatalog(currentCatalogId);
      document.getElementById('op-amount').value = '';
      Toast.info(`-${amount} ‚ÇΩ —Å–ø–∏—Å–∞–Ω–æ`);
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    function saveCatalogs() {
      localStorage.setItem('finance_catalogs', JSON.stringify(catalogs));
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞
    document.addEventListener('DOMContentLoaded', () => {
      init();
      Toast.info('–§–∏–Ω–∞–Ω—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    });
  </script>
{% endblock %}