{% extends "base.html" %}

{% block title %}Админ — Лео{% endblock %}

{% block styles %}
<style>
/* Только то, что нужно для админки */
.admin-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin: 24px 0;
}

.api-section {
  margin: 24px 0;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border-light);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--accent);
  width: 0%;
  transition: width 0.4s ease;
}

/* Новые стили для тикетов */
.support-row {
  display: flex;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-light);
}

.support-user {
  flex: 1;
  font-size: 14px;
}

.support-user .name {
  font-weight: 500;
  color: var(--text-primary);
}

.support-user .username {
  color: var(--text-secondary);
  font-size: 12px;
}

.support-message {
  flex: 2;
  color: var(--text-primary);
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.support-actions {
  flex: 1;
  text-align: right;
}

.reply-btn {
  padding: 6px 12px;
  font-size: 12px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: 0.2s;
}

.reply-btn:hover {
  background: #0056b3;
}

/* Форма ответа */
.reply-form {
  margin-top: 8px;
  padding: 12px;
  background: var(--bg-light);
  border-radius: 8px;
  display: none;
}

.reply-form textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid var(--border-light);
  border-radius: 4px;
  font-size: 14px;
  resize: none;
  height: 60px;
}

.reply-form button {
  margin-top: 8px;
  padding: 6px 12px;
  font-size: 12px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.reply-form .cancel {
  background: var(--text-secondary);
}
</style>
{% endblock %}

{% block content %}
  <!-- Статистика -->
  <div class="card">
    <div class="section-title">
      <span class="material-icons">insights</span> Статистика
    </div>
    <div class="admin-grid" id="stats-container">
      Загрузка...
    </div>
  </div>

  <!-- API -->
  <div class="card">
    <div class="section-title">
      <span class="material-icons">api</span> GigaChat API
    </div>
    <div style="font-size: 14px; color: var(--text-secondary);">
      Использовано: <strong id="api-used">0</strong> / <span id="api-limit">100</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="api-progress-fill"></div>
    </div>
    <div style="margin-top: 12px;">
      <input type="number" id="new-api-limit" placeholder="Новый лимит" style="padding: 8px; width: 200px;">
      <button class="btn-primary" style="padding: 8px 16px; margin-left: 8px;" onclick="updateApiLimit()">
        Обновить
      </button>
    </div>
  </div>

  <!-- Техподдержка -->
  <div class="card">
    <div class="section-title">
      <span class="material-icons">help</span> Техподдержка
    </div>
    <table class="user-table">
      <thead>
        <tr>
          <th>Пользователь</th>
          <th>Сообщение</th>
          <th>Действие</th>
        </tr>
      </thead>
      <tbody id="support-requests">
        <!-- Будет заполнено через JavaScript -->
      </tbody>
    </table>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/admin.js"></script>
  <script>
    // Глобальная переменная для хранения тикетов
    let supportTickets = [];

    // Инициализация API
    function updateApiDisplay() {
      const used = statsData.api_usage?.gigachat?.used || 0;
      const limit = statsData.api_usage?.gigachat?.limit || 100;
      const percent = Math.min(100, (used / limit) * 100);

      document.getElementById('api-used').textContent = used;
      document.getElementById('api-limit').textContent = limit;
      document.getElementById('api-progress-fill').style.width = percent + '%';
      document.getElementById('new-api-limit').value = limit;
    }

    window.updateStatsDisplay = function() {
      originalUpdateStatsDisplay();
      updateApiDisplay();
    };

    // Загрузка тикетов
    async function loadSupportTickets() {
      try {
        const response = await fetch('/api/admin/support-tickets'); // Мы добавим этот эндпоинт позже
        if (!response.ok) throw new Error('Ошибка загрузки');
        supportTickets = await response.json();
        renderSupportTickets();
      } catch (err) {
        console.error('Ошибка:', err);
        document.getElementById('support-requests').innerHTML = `
          <tr><td colspan="3">❌ Не удалось загрузить тикеты</td></tr>
        `;
      }
    }

    // Отображение тикетов
    function renderSupportTickets() {
      const container = document.getElementById('support-requests');
      if (!supportTickets.length) {
        container.innerHTML = `<tr><td colspan="3">Нет открытых запросов</td></tr>`;
        return;
      }

      container.innerHTML = supportTickets.map(ticket => `
        <tr>
          <td>
            <div class="support-user">
              <div class="name">${ticket.first_name || 'Пользователь'}</div>
              <div class="username">@${ticket.username || 'unknown'}</div>
            </div>
          </td>
          <td>
            <div class="support-message" title="${ticket.message}">
              ${ticket.message.length > 50 ? ticket.message.slice(0, 50) + '...' : ticket.message}
            </div>
          </td>
          <td class="support-actions">
            <button class="reply-btn" onclick="toggleReplyForm('${ticket.ticket_id}')">Ответить</button>
            <div class="reply-form" id="reply-form-${ticket.ticket_id}">
              <textarea placeholder="Введите ответ..."></textarea>
              <button onclick="sendReply('${ticket.ticket_id}')">Отправить</button>
              <button class="cancel" onclick="toggleReplyForm('${ticket.ticket_id}')">Отмена</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Показать/скрыть форму ответа
    function toggleReplyForm(ticketId) {
      const form = document.getElementById(`reply-form-${ticketId}`);
      form.style.display = form.style.display === 'none' || !form.style.display ? 'block' : 'none';
    }

    // Отправить ответ
    async function sendReply(ticketId) {
      const form = document.getElementById(`reply-form-${ticketId}`);
      const textarea = form.querySelector('textarea');
      const replyText = textarea.value.trim();
      if (!replyText) return alert('Введите текст ответа');

      try {
        const response = await fetch('/api/admin/reply-ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticket_id: ticketId, reply_text: replyText })
        });

        if (response.ok) {
          alert('Ответ отправлен');
          // Убираем тикет из списка
          supportTickets = supportTickets.filter(t => t.ticket_id !== ticketId);
          renderSupportTickets();
        } else {
          const data = await response.json();
          alert('Ошибка: ' + (data.detail || 'неизвестная'));
        }
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }

      textarea.value = '';
      toggleReplyForm(ticketId);
    }

    // Загружаем тикеты после DOM
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(updateApiDisplay, 800);
      loadSupportTickets();
    });
  </script>
{% endblock %}