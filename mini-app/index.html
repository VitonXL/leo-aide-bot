<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leo Aide</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --card-bg: white;
      --text: #333;
      --accent: #0088cc;
      --danger: #d9534f;
      --success: #5cb85c;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1c1c1e;
        --card-bg: #2c2c2e;
        --text: #f1f1f1;
      }
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      transition: background 0.3s;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }
    h2, h3 {
      margin: 0 0 10px 0;
      color: var(--accent);
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
    }
    input {
      background: var(--card-bg);
      color: var(--text);
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .loader {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    .premium-badge {
      background: #ff9f0a;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <div class="header">
    <h2>üëã <span id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span></h2>
    <div id="premium-status"></div>
  </div>

  <div class="card">
    <h3>üå§ –ü–æ–≥–æ–¥–∞</h3>
    <input type="text" id="city" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥" />
    <button onclick="getWeather()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    <div id="weather-result"></div>
  </div>

  <div class="card">
    <h3>üí± –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h3>
    <button onclick="getCurrency()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <div id="currency-result"></div>
  </div>

  <div class="card">
    <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏</h3>
    <input type="text" id="url" placeholder="https://example.com" />
    <button onclick="scanUrl()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    <div id="scan-result"></div>
  </div>

  <div class="card">
    <h3>üíé –ü—Ä–µ–º–∏—É–º</h3>
    <button onclick="buyPremium()">–ö—É–ø–∏—Ç—å –∑–∞ 50‚ÇΩ (0.02 TON)</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    const API_URL = "https://leo-aide-bot.onrender.com";  // ‚Üê URL –≤–∞—à–µ–≥–æ Web Service
    const user = tg.initDataUnsafe.user;
    let scanCount = 0;

    // --- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è ---
    document.getElementById("user-name").textContent = user?.first_name || "–î—Ä—É–≥";

    // --- –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä) ---
    const isPremium = false; // ‚Üê –∑–∞–≥–ª—É—à–∫–∞. –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: /api/user/status
    if (isPremium) {
      document.getElementById("premium-status").innerHTML = '<span class="premium-badge">–ü—Ä–µ–º–∏—É–º</span>';
    }

    // --- –ü–æ–≥–æ–¥–∞ ---
    async function getWeather() {
      const city = document.getElementById("city").value.trim();
      if (!city) return alert("–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥");
      document.getElementById("weather-result").innerHTML = "<div class='loader'>–ü–æ–ª—É—á–∞–µ–º...</div>";

      // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: –∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É –±–æ—Ç—É (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç–µ API)
      // –°–µ–π—á–∞—Å ‚Äî –∑–∞–≥–ª—É—à–∫–∞
      setTimeout(() => {
        document.getElementById("weather-result").innerHTML =
          `<b>–ì–æ—Ä–æ–¥:</b> ${city}<br><b>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</b> 22¬∞C<br><b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> –°–æ–ª–Ω–µ—á–Ω–æ`;
      }, 1000);
    }

    // --- –ö—É—Ä—Å—ã ---
    async function getCurrency() {
      document.getElementById("currency-result").innerHTML = "<div class='loader'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";
      try {
        const res = await fetch("https://www.cbr-xml-daily.ru/latest.js");
        const data = await res.json();
        const r = data.rates;
        document.getElementById("currency-result").innerHTML = `
          <b>USD:</b> ${r.USD.toFixed(2)} ‚ÇΩ<br>
          <b>EUR:</b> ${r.EUR.toFixed(2)} ‚ÇΩ<br>
          <b>CNY:</b> ${r.CNY.toFixed(2)} ‚ÇΩ
        `;
      } catch (e) {
        document.getElementById("currency-result").innerHTML = "‚ùå –û—à–∏–±–∫–∞";
      }
    }

    // --- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ ---
    async function scanUrl() {
      const url = document.getElementById("url").value.trim();
      if (!url.startsWith("http")) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É");
      if (!isPremium) {
        tg.showAlert("üîí –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º");
        return;
      }

      document.getElementById("scan-result").innerHTML = "<div class='loader'>–û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É...</div>";

      try {
        const res = await fetch(`${API_URL}/scan/url`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });

        const data = await res.json();
        if (data.scan_id) {
          checkResult(data.scan_id);
        } else {
          document.getElementById("scan-result").innerHTML = "‚ùå –û—à–∏–±–∫–∞: " + (data.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
        }
      } catch (e) {
        document.getElementById("scan-result").innerHTML = "‚ùå –°–µ—Ç—å: " + e.message;
      }
    }

    // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ---
    function checkResult(scan_id) {
      document.getElementById("scan-result").innerHTML = "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...";
      const interval = setInterval(async () => {
        try {
          const res = await fetch(`${API_URL}/scan/result?id=${scan_id}`);
          const result = await res.json();
          clearInterval(interval);

          if (result.safe) {
            document.getElementById("scan-result").innerHTML = "üü¢ <b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ:</b> 0 —É–≥—Ä–æ–∑";
          } else {
            document.getElementById("scan-result").innerHTML =
              `üî¥ <b>–û–ø–∞—Å–Ω–æ:</b> ${result.malicious} —É–≥—Ä–æ–∑ –∏–∑ ${result.total}`;
          }
        } catch (e) { console.error(e); }
      }, 5000);
    }

    // --- –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–º–∏—É–º ---
    function buyPremium() {
      const comment = `premium_50_${user.id}`;
      const url = `https://t.me/wallet/start?startapp=transfer-UQCAjhZZOSxbEUB84daLpOXBPkQIWy3oB-fWoTztKdAZFDLQ&text=${encodeURIComponent(comment)}`;
      tg.openTelegramLink(url);
    }
  </script>

</body>
</html>
